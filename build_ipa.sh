#!/bin/bash

# HolySpots IPA Build Script
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏ IPA —Ñ–∞–π–ª–∞ Flutter iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É IPA –¥–ª—è HolySpots..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "pubspec.yaml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: pubspec.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ Flutter –ø—Ä–æ–µ–∫—Ç–∞."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Xcode —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v xcodebuild &> /dev/null; then
    echo "‚ùå –û—à–∏–±–∫–∞: Xcode –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Xcode –¥–ª—è —Å–±–æ—Ä–∫–∏ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π."
    exit 1
fi

# –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏
echo "üßπ –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–±–æ—Ä–∫–∏..."
flutter clean

# –ü–æ–ª—É—á–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –ü–æ–ª—É—á–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
flutter pub get

# –ü—Ä–æ–≤–µ—Ä—è–µ–º Flutter
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Flutter..."
flutter doctor

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ iOS –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd ios

# –û—á–∏—â–∞–µ–º iOS –ø—Ä–æ–µ–∫—Ç
echo "üßπ –û—á–∏—â–∞–µ–º iOS –ø—Ä–æ–µ–∫—Ç..."
xcodebuild clean -workspace Runner.xcworkspace -scheme Runner

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd ..

# –°–æ–±–∏—Ä–∞–µ–º iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üî® –°–æ–±–∏—Ä–∞–µ–º iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
flutter build ios --release --no-codesign

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
if [ $? -eq 0 ]; then
    echo "‚úÖ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω–æ!"
    echo "üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤: build/ios/iphoneos/Runner.app"
    
    # –°–æ–∑–¥–∞–µ–º IPA —Ñ–∞–π–ª (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –∫–æ–¥)
    echo "üì¶ –°–æ–∑–¥–∞–µ–º IPA —Ñ–∞–π–ª..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    if [ -d "build/ios/iphoneos/Runner.app" ]; then
        echo "üìè –†–∞–∑–º–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $(du -sh build/ios/iphoneos/Runner.app | cut -f1)"
        echo "‚ÑπÔ∏è  –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è IPA —Ñ–∞–π–ª–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –∫–æ–¥."
        echo "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Xcode –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—è IPA:"
        echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ ios/Runner.xcworkspace –≤ Xcode"
        echo "   2. –í—ã–±–µ—Ä–∏—Ç–µ Product -> Archive"
        echo "   3. –í Organizer –≤—ã–±–µ—Ä–∏—Ç–µ Distribute App"
        echo "   4. –í—ã–±–µ—Ä–∏—Ç–µ Ad Hoc –∏–ª–∏ App Store"
        echo "   5. –ü–æ–¥–ø–∏—à–∏—Ç–µ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ IPA"
    else
        echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ build/ios/iphoneos/Runner.app"
    fi
    
    echo "üéâ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ iOS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi 